<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>三人対戦テトリス NEO</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #1a1a2e;
      --primary-color: #e94560;
      --secondary-color: #0f3460;
      --font-color: #ffffff;
      --glow-color: #fca311;
      --border-color: rgba(255, 255, 255, 0.2);
    }

    body {
      background: linear-gradient(135deg, var(--bg-color) 0%, #16213e 50%, var(--bg-color) 100%);
      color: var(--font-color);
      font-family: 'Orbitron', 'Press Start 2P', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      text-align: center;
      overflow-x: auto;
    }

    h1 {
      font-family: 'Press Start 2P', monospace;
      font-size: 2.5rem;
      color: var(--primary-color);
      text-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--primary-color), 0 0 30px var(--primary-color);
      margin-bottom: 30px;
      letter-spacing: 2px;
    }

    #start-container {
      margin-bottom: 30px;
    }

    .retro-button {
      font-family: 'Orbitron', monospace;
      background: linear-gradient(45deg, var(--primary-color), #ff6b7d);
      color: var(--font-color);
      border: 2px solid var(--glow-color);
      padding: 15px 30px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.3s ease;
      box-shadow: 0 5px 0 #b32a3e, 0 8px 15px rgba(0,0,0,0.4), 0 0 0 var(--glow-color);
      border-radius: 8px;
      letter-spacing: 1px;
    }

    .retro-button:hover:not(:disabled) {
      background: linear-gradient(45deg, #ff6b7d, var(--glow-color));
      transform: translateY(-2px);
      box-shadow: 0 7px 0 #b32a3e, 0 10px 20px rgba(0,0,0,0.5), 0 0 20px var(--glow-color);
      text-shadow: 0 0 10px rgba(255,255,255,0.8);
    }

    .retro-button:active:not(:disabled) {
      transform: translateY(5px);
      box-shadow: 0 0 0 #b32a3e, 0 3px 10px rgba(0,0,0,0.3);
    }
    
    .retro-button:disabled {
        background-color: #6c757d;
        box-shadow: 0 5px 0 #4a5157;
        cursor: not-allowed;
    }
    
    #game-container {
      display: none; /* Initially hidden */
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
      width: 100%;
      flex-wrap: wrap; /* Allow wrapping on smaller screens */
    }

    .player-container {
      background-color: var(--secondary-color);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 0 15px rgba(0,0,0,0.3);
      width: clamp(300px, 30vw, 400px); /* Responsive width */
    }

    .player-title {
        font-size: 1.5rem;
        margin-bottom: 15px;
        color: var(--primary-color);
        text-shadow: 0 0 5px var(--primary-color);
    }

    .game-area {
        display: flex;
        gap: 10px;
        width: 100%;
    }

    canvas {
      border: 1px solid var(--border-color);
      background-color: #000;
    }

    .player-container canvas {
       width: 75%;
       height: auto;
    }

    .side-panel {
        width: 25%;
        display: flex;
        flex-direction: column;
        gap: 10px;
        font-size: 0.8rem;
    }

    .info-box {
        background: #111;
        border: 1px solid var(--border-color);
        padding: 10px;
        border-radius: 5px;
        text-align: center;
    }

    .info-box h3 {
        margin: 0 0 10px 0;
        font-size: 0.9rem;
        color: var(--glow-color);
    }
    
    .info-box div {
        font-size: 1rem;
    }

    .side-panel canvas {
        width: 100%;
        height: auto;
        aspect-ratio: 1 / 1;
    }

    .controls-info {
      font-size: 0.7rem;
      margin-top: 15px;
      line-height: 1.5;
      color: #aaa;
    }
    
    #player-setup {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .player-select-card {
        background-color: var(--secondary-color);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
    }

    .player-select-card h2 {
        margin-top: 0;
        color: var(--primary-color);
    }

    .player-mode-button {
        font-family: 'Orbitron', monospace;
        font-weight: 600;
        background-color: #4CAF50;
        color: white;
        padding: 12px 20px;
        border: 2px solid transparent;
        cursor: pointer;
        width: 160px;
        text-align: center;
        border-radius: 8px;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .player-mode-button[data-mode="CPU"] { background-color: #fca311; }
    .player-mode-button[data-mode="OFF"] { background-color: #6c757d; }

    .game-over-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        color: red;
        text-shadow: 2px 2px #000, 0 0 15px red;
        display: none;
        z-index: 100;
        padding: 20px;
        background: rgba(0,0,0,0.7);
        border-radius: 10px;
    }

    .pause-menu {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 200;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .pause-content {
        background: var(--secondary-color);
        border: 2px solid var(--border-color);
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        min-width: 300px;
    }

    .pause-content h2 {
        color: var(--primary-color);
        margin-bottom: 20px;
        font-size: 1.5rem;
    }

    .pause-content .retro-button {
        display: block;
        margin: 10px auto;
        width: 200px;
    }

    .controller-guide {
        background: rgba(15, 52, 96, 0.9);
        border: 2px solid var(--border-color);
        border-radius: 15px;
        padding: 25px;
        margin: 20px 0;
        max-width: 1200px;
        width: 100%;
        box-shadow: 0 0 30px rgba(0,0,0,0.5);
    }

    .controller-guide h2 {
        font-family: 'Press Start 2P', monospace;
        color: var(--glow-color);
        text-align: center;
        margin-bottom: 25px;
        font-size: 1.5rem;
        text-shadow: 0 0 10px var(--glow-color);
    }

    .controller-layouts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .controller-section {
        background: rgba(26, 26, 46, 0.8);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 20px;
    }

    .controller-section h3 {
        font-family: 'Orbitron', monospace;
        color: var(--primary-color);
        margin-bottom: 15px;
        font-size: 1.1rem;
        text-align: center;
    }

    .controls-grid {
        display: grid;
        gap: 8px;
    }

    .control-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: rgba(0,0,0,0.3);
        border-radius: 6px;
        font-size: 0.85rem;
    }

    .button-icon {
        font-family: 'Orbitron', monospace;
        font-weight: 600;
        color: var(--glow-color);
        min-width: 120px;
        text-align: left;
    }

    .control-desc {
        color: #ccc;
        text-align: right;
        flex: 1;
    }

    .controller-tips {
        background: rgba(0,0,0,0.4);
        border-radius: 10px;
        padding: 20px;
        border: 1px solid var(--border-color);
    }

    .controller-tips h3 {
        font-family: 'Orbitron', monospace;
        color: var(--glow-color);
        margin-bottom: 15px;
        font-size: 1.1rem;
    }

    .controller-tips ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .controller-tips li {
        padding: 8px 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .controller-tips li:last-child {
        border-bottom: none;
    }

    @media (max-width: 768px) {
        .controller-guide {
            padding: 15px;
            margin: 10px;
        }
        
        .controller-layouts {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .control-item {
            flex-direction: column;
            text-align: center;
            gap: 5px;
        }
        
        .button-icon, .control-desc {
            text-align: center;
            min-width: auto;
        }
    }


  </style>
</head>
<body>

  <h1>三人対戦テトリス NEO</h1>

  <!-- Controller Guide Toggle -->
  <div class="guide-toggle">
    <button id="toggleGuide" class="retro-button">🎮 コントローラーガイドを表示</button>
  </div>

  <!-- Controller Instructions -->
  <div id="controller-instructions" class="controller-guide" style="display: none;">
    <h2>🎮 コントローラー操作ガイド</h2>
    <div class="controller-layouts">
      
      <!-- Xbox Controller -->
      <div class="controller-section">
        <h3>🎯 Xbox / Xbox One / Xbox Series</h3>
        <div class="controls-grid">
          <div class="control-item">
            <span class="button-icon xbox-dpad">十字キー ↕️↔️</span>
            <span class="control-desc">メニュー移動 / ブロック移動</span>
          </div>
          <div class="control-item">
            <span class="button-icon xbox-lstick">左スティック 🕹️</span>
            <span class="control-desc">メニュー移動 / ブロック移動</span>
          </div>
          <div class="control-item">
            <span class="button-icon xbox-a">Aボタン 🅰️</span>
            <span class="control-desc">決定 / ブロック回転</span>
          </div>
          <div class="control-item">
            <span class="button-icon xbox-b">Bボタン 🅱️</span>
            <span class="control-desc">戻る / 一時停止</span>
          </div>
          <div class="control-item">
            <span class="button-icon xbox-start">STARTボタン ⏸️</span>
            <span class="control-desc">ゲーム開始 / 一時停止</span>
          </div>
          <div class="control-item">
            <span class="button-icon xbox-lb">LBボタン 🔄</span>
            <span class="control-desc">ハードドロップ</span>
          </div>
        </div>
      </div>

      <!-- PlayStation Controller -->
      <div class="controller-section">
        <h3>🎯 PlayStation DualShock / DualSense</h3>
        <div class="controls-grid">
          <div class="control-item">
            <span class="button-icon ps-dpad">十字キー ↕️↔️</span>
            <span class="control-desc">メニュー移動 / ブロック移動</span>
          </div>
          <div class="control-item">
            <span class="button-icon ps-lstick">左スティック 🕹️</span>
            <span class="control-desc">メニュー移動 / ブロック移動</span>
          </div>
          <div class="control-item">
            <span class="button-icon ps-x">✕ボタン</span>
            <span class="control-desc">決定 / ブロック回転</span>
          </div>
          <div class="control-item">
            <span class="button-icon ps-circle">○ボタン</span>
            <span class="control-desc">戻る / 一時停止</span>
          </div>
          <div class="control-item">
            <span class="button-icon ps-options">OPTIONSボタン ⏸️</span>
            <span class="control-desc">ゲーム開始 / 一時停止</span>
          </div>
          <div class="control-item">
            <span class="button-icon ps-l1">L1ボタン 🔄</span>
            <span class="control-desc">ハードドロップ</span>
          </div>
        </div>
      </div>

      <!-- Nintendo Switch -->
      <div class="controller-section">
        <h3>🎯 Nintendo Switch Pro Controller</h3>
        <div class="controls-grid">
          <div class="control-item">
            <span class="button-icon switch-dpad">十字ボタン ↕️↔️</span>
            <span class="control-desc">メニュー移動 / ブロック移動</span>
          </div>
          <div class="control-item">
            <span class="button-icon switch-lstick">左スティック 🕹️</span>
            <span class="control-desc">メニュー移動 / ブロック移動</span>
          </div>
          <div class="control-item">
            <span class="button-icon switch-a">Aボタン</span>
            <span class="control-desc">決定 / ブロック回転</span>
          </div>
          <div class="control-item">
            <span class="button-icon switch-b">Bボタン</span>
            <span class="control-desc">戻る / 一時停止</span>
          </div>
          <div class="control-item">
            <span class="button-icon switch-plus">+ボタン ⏸️</span>
            <span class="control-desc">ゲーム開始 / 一時停止</span>
          </div>
          <div class="control-item">
            <span class="button-icon switch-l">Lボタン 🔄</span>
            <span class="control-desc">ハードドロップ</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="controller-tips">
      <h3>💡 操作のコツ</h3>
      <ul>
        <li>🔌 コントローラーを接続してから任意のボタンを押すと自動認識されます</li>
        <li>🎮 複数のコントローラーが自動的に各プレイヤーに割り当てられます</li>
        <li>⏸️ ゲーム中はSTARTボタンまたはBボタンで一時停止できます</li>
        <li>🔄 十字キーとアナログスティックの両方で操作可能です</li>
        <li>🎯 キーボード操作とコントローラー操作を混在できます</li>
      </ul>
    </div>
  </div>

  <div id="player-setup">
    <div class="player-select-card">
      <h2>PLAYER 1</h2>
      <button class="player-mode-button" id="togglePlayer1" data-mode="ON">参加する</button>
    </div>
    <div class="player-select-card">
      <h2>PLAYER 2</h2>
      <button class="player-mode-button" id="togglePlayer2" data-mode="CPU">CPU</button>
    </div>
    <div class="player-select-card">
      <h2>PLAYER 3</h2>
      <button class="player-mode-button" id="togglePlayer3" data-mode="OFF">参加しない</button>
    </div>
  </div>

  <div id="start-container">
    <button id="startButton" class="retro-button">ゲームスタート</button>
  </div>

  <div id="game-container">
    <!-- Player 1 Container -->
    <div class="player-container" id="p1-container" style="display: none;">
      <div class="player-title">PLAYER 1</div>
      <div class="game-area">
          <canvas id="player1Canvas"></canvas>
          <div class="side-panel">
              <div class="info-box">
                  <h3>SCORE</h3>
                  <div id="player1Score">0</div>
              </div>
              <div class="info-box">
                  <h3>NEXT</h3>
                  <canvas id="player1Next"></canvas>
              </div>
          </div>
      </div>
      <small class="controls-info">矢印:移動 / ↑:ハードドロップ / Z:回転</small>
    </div>

    <!-- Player 2 Container -->
    <div class="player-container" id="p2-container" style="display: none;">
      <div class="player-title">PLAYER 2</div>
      <div class="game-area">
          <canvas id="player2Canvas"></canvas>
          <div class="side-panel">
              <div class="info-box">
                  <h3>SCORE</h3>
                  <div id="player2Score">0</div>
              </div>
               <div class="info-box">
                  <h3>NEXT</h3>
                  <canvas id="player2Next"></canvas>
              </div>
          </div>
      </div>
      <small class="controls-info">A,D,S:移動 / W:ハードドロップ / E:回転</small>
    </div>

    <!-- Player 3 Container -->
    <div class="player-container" id="p3-container" style="display: none;">
      <div class="player-title">PLAYER 3</div>
       <div class="game-area">
          <canvas id="player3Canvas"></canvas>
          <div class="side-panel">
              <div class="info-box">
                  <h3>SCORE</h3>
                  <div id="player3Score">0</div>
              </div>
               <div class="info-box">
                  <h3>NEXT</h3>
                  <canvas id="player3Next"></canvas>
              </div>
          </div>
      </div>
      <small class="controls-info">J,L,K:移動 / I:ハードドロップ / O:回転</small>
    </div>
  </div>
  
  <div id="gameOverMessage" class="game-over-message">GAME OVER</div>
  
  <!-- Pause Menu -->
  <div id="pauseMenu" class="pause-menu" style="display: none;">
    <div class="pause-content">
      <h2>一時停止</h2>
      <button id="resumeButton" class="retro-button">再開</button>
      <button id="restartButton" class="retro-button">リスタート</button>
      <button id="quitButton" class="retro-button">終了</button>
    </div>
  </div>

  <script src="tetris.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const startButton = document.getElementById('startButton');
        
        // Initialize GamepadManager and force immediate detection
        console.log('=== Initializing Gamepad System ===');
        console.log('Browser:', navigator.userAgent);
        console.log('Gamepad API supported:', !!navigator.getGamepads);
        
        gamepadManager.startMonitoring();
        console.log('GamepadManager monitoring started');
        
        gamepadManager.forceRefreshGamepads();
        console.log('Initial gamepad refresh completed');
        
        // Setup UI navigation for start screen
        const playerButtons = [
            document.getElementById('toggleGuide'),
            document.getElementById('togglePlayer1'),
            document.getElementById('togglePlayer2'),
            document.getElementById('togglePlayer3'),
            document.getElementById('startButton')
        ];
        
        uiNavigation.setFocusableElements(playerButtons);
        uiNavigation.enable();
        
        // Force gamepad refresh periodically and handle UI navigation
        setInterval(() => {
            gamepadManager.forceRefreshGamepads();
            uiNavigation.handleGamepadInput();
            handleGlobalGamepadInput();
        }, 100); // More frequent for responsive UI
        
        // Pause menu button event listeners
        document.getElementById('resumeButton').addEventListener('click', resumeGame);
        document.getElementById('restartButton').addEventListener('click', restartGame);
        document.getElementById('quitButton').addEventListener('click', restartGame);
        
        // Controller guide toggle
        const toggleGuideBtn = document.getElementById('toggleGuide');
        const controllerInstructions = document.getElementById('controller-instructions');
        let guideVisible = false;
        
        toggleGuideBtn.addEventListener('click', () => {
            guideVisible = !guideVisible;
            if (guideVisible) {
                controllerInstructions.style.display = 'block';
                toggleGuideBtn.textContent = '🎮 コントローラーガイドを非表示';
            } else {
                controllerInstructions.style.display = 'none';
                toggleGuideBtn.textContent = '🎮 コントローラーガイドを表示';
            }
        });
        
        
        // Gamepad connection events
        window.addEventListener('gamepadconnected', (e) => {
            console.log('Gamepad connected:', e.gamepad.id, 'at index', e.gamepad.index);
            gamepadManager.updateAvailableGamepads();
        });
        
        window.addEventListener('gamepaddisconnected', (e) => {
            console.log('Gamepad disconnected:', e.gamepad.id, 'at index', e.gamepad.index);
            gamepadManager.updateAvailableGamepads();
        });
        
        if (typeof Tetris === 'undefined') {
            console.error("エラー: 'Tetris' クラスが見つかりません。tetris.jsを確認してください。");
            startButton.textContent = "読み込みエラー";
            startButton.disabled = true;
            return;
        }

        const playerModes = ['ON', 'CPU', 'OFF'];
        
        playerButtons.forEach(button => {
            button.addEventListener('click', () => {
                let currentModeIndex = playerModes.indexOf(button.dataset.mode);
                let nextModeIndex = (currentModeIndex + 1) % playerModes.length;
                let nextMode = playerModes[nextModeIndex];
                button.dataset.mode = nextMode;
                const modeText = {'ON': '参加する', 'CPU': 'CPU', 'OFF': '参加しない'};
                button.textContent = modeText[nextMode];
            });
        });

        const setupDiv = document.getElementById('player-setup');
        const gameContainer = document.getElementById('game-container');
        const pauseMenu = document.getElementById('pauseMenu');
        let gameInstances = [];
        let animationFrameId;
        let isPaused = false;
        let gameState = 'menu'; // 'menu', 'playing', 'paused', 'gameover'

        function requestFullScreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        function pauseGame() {
            if (gameState !== 'playing') return;
            
            isPaused = true;
            gameState = 'paused';
            pauseMenu.style.display = 'flex';
            
            // Setup pause menu navigation
            const pauseButtons = [
                document.getElementById('resumeButton'),
                document.getElementById('restartButton'),
                document.getElementById('quitButton')
            ];
            uiNavigation.setFocusableElements(pauseButtons);
            
            console.log('Game paused');
        }

        function resumeGame() {
            if (gameState !== 'paused') return;
            
            isPaused = false;
            gameState = 'playing';
            pauseMenu.style.display = 'none';
            uiNavigation.disable();
            
            // Resume game loop
            if (gameInstances.length > 0) {
                animationFrameId = requestAnimationFrame(gameLoop);
            }
            
            console.log('Game resumed');
        }

        function restartGame() {
            // Stop current game
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            // Clean up gamepad assignments
            gameInstances.forEach(game => {
                gamepadManager.unassignPlayer(game.playerId);
            });
            
            // Reset UI
            pauseMenu.style.display = 'none';
            gameContainer.style.display = 'none';
            setupDiv.style.display = 'flex';
            startButton.parentElement.style.display = 'block';
            document.getElementById('gameOverMessage').style.display = 'none';
            
            // Reset state
            gameInstances = [];
            isPaused = false;
            gameState = 'menu';
            
            // Setup menu navigation
            const menuButtons = [
                document.getElementById('toggleGuide'),
                document.getElementById('togglePlayer1'),
                document.getElementById('togglePlayer2'),
                document.getElementById('togglePlayer3'),
                document.getElementById('startButton')
            ];
            uiNavigation.setFocusableElements(menuButtons);
            uiNavigation.enable();
            
            console.log('Game restarted');
        }

        // Global gamepad input handler for pause/menu functions
        function handleGlobalGamepadInput() {
            const gamepads = navigator.getGamepads();
            for (let i = 0; i < gamepads.length; i++) {
                if (gamepads[i]) {
                    const gamepad = gamepads[i];
                    
                    // Pause game with START button during gameplay
                    if (gameState === 'playing' && gamepadMapper.isButtonPressed(gamepad, 'START')) {
                        const now = Date.now();
                        if (!window.lastPauseTime || now - window.lastPauseTime > 500) {
                            pauseGame();
                            window.lastPauseTime = now;
                        }
                    }
                    
                    // Back button (B) to go back or pause
                    if (gamepadMapper.isButtonPressed(gamepad, 'B')) {
                        const now = Date.now();
                        if (!window.lastBackTime || now - window.lastBackTime > 500) {
                            if (gameState === 'playing') {
                                pauseGame();
                            } else if (gameState === 'paused') {
                                resumeGame();
                            }
                            window.lastBackTime = now;
                        }
                    }
                    
                    // Game over restart
                    if (gameState === 'gameover' && 
                        (gamepadMapper.isButtonPressed(gamepad, 'A') || 
                         gamepadMapper.isButtonPressed(gamepad, 'START'))) {
                        const now = Date.now();
                        if (!window.lastRestartTime || now - window.lastRestartTime > 1000) {
                            restartGame();
                            window.lastRestartTime = now;
                        }
                    }
                }
            }
        }

        startButton.addEventListener('click', () => {
            setupDiv.style.display = 'none';
            startButton.parentElement.style.display = 'none';
            document.getElementById('gameOverMessage').style.display = 'none';
            gameContainer.style.display = 'flex';
            
            // Set game state
            gameState = 'playing';
            isPaused = false;
            uiNavigation.disable();
            
            // Request fullscreen
            requestFullScreen();

            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            gameInstances = []; 
            
            // まず利用可能なプレイヤーにコントローラーを自動割り当て
            const activePlayers = [];
            const gamePlayerButtons = [
                document.getElementById('togglePlayer1'),
                document.getElementById('togglePlayer2'),
                document.getElementById('togglePlayer3')
            ];
            gamePlayerButtons.forEach((button, index) => {
                const playerId = index + 1;
                const mode = button.dataset.mode;
                if (mode !== 'OFF') {
                    activePlayers.push(playerId);
                }
            });
            
            // アクティブなプレイヤーにコントローラーを順番に割り当て
            console.log('=== GAME START: Controller Assignment ===');
            console.log('Active players:', activePlayers);
            console.log('Available gamepads before assignment:', gamepadManager.availableGamepads.length);
            
            activePlayers.forEach(playerId => {
                console.log(`Attempting to assign controller to Player ${playerId}...`);
                const result = gamepadManager.assignGamepadToPlayer(playerId);
                if (result !== null) {
                    console.log(`✓ Player ${playerId} assigned gamepad ${result}`);
                } else {
                    console.error(`✗ Player ${playerId} assignment FAILED`);
                }
            });
            
            console.log('Final assignment state:', gamepadManager.getAssignmentInfo());
            
            gamePlayerButtons.forEach((button, index) => {
                const playerId = index + 1;
                const mode = button.dataset.mode;
                const playerContainer = document.getElementById(`p${playerId}-container`);
                if (mode !== 'OFF') {
                    playerContainer.style.display = 'flex';
                    const game = new Tetris(playerId, mode);
                    game.start();
                    gameInstances.push(game);
                } else {
                    playerContainer.style.display = 'none';
                }
            });

            if(gameInstances.length > 0) {
              // Log gamepad assignments
              console.log('Game started with gamepad assignments:', gamepadManager.getAssignmentInfo());
              
              function gameLoop(time) {
                  // Don't update if paused
                  if (isPaused || gameState !== 'playing') {
                      return;
                  }
                  
                  const activeGames = gameInstances.filter(game => !game.gameOver);

                  if (gameInstances.length > 1 && activeGames.length <= 1) {
                      const gameOverMsg = document.getElementById('gameOverMessage');
                      gameOverMsg.textContent = activeGames.length === 1 ? `PLAYER ${activeGames[0].playerId} WINS!` : 'DRAW!';
                      gameOverMsg.style.display = 'block';
                      gameState = 'gameover';
                      cancelAnimationFrame(animationFrameId);
                      
                      // Setup game over navigation after delay
                      setTimeout(() => {
                          gameOverMsg.innerHTML = `
                              ${gameOverMsg.textContent}<br>
                              <small style="font-size: 0.8rem; margin-top: 20px; display: block;">
                                  コントローラーのAボタンまたはSTARTボタンでリスタート
                              </small>
                          `;
                      }, 2000);
                      
                      // Clean up gamepad assignments
                      gameInstances.forEach(game => {
                          gamepadManager.unassignPlayer(game.playerId);
                      });
                      
                      return;
                  }
                  
                  gameInstances.forEach(currentGame => {
                      if (currentGame.gameOver) return;
                      const clearedLines = currentGame.update(time);
                      if (clearedLines >= 2) {
                          gameInstances.forEach(otherPlayer => {
                              if (otherPlayer !== currentGame && !otherPlayer.gameOver) {
                                  const attackLines = clearedLines >= 4 ? 3 : 1;
                                  otherPlayer.addObstacle(attackLines);
                              }
                          });
                      }
                  });
                  animationFrameId = requestAnimationFrame(gameLoop);
              }
              animationFrameId = requestAnimationFrame(gameLoop);
            }
        });
        
        document.addEventListener('keydown', event => {
            const humanPlayers = gameInstances.filter(g => g.mode === 'ON' && !g.gameOver);
            if (humanPlayers.length === 0) return;

            const handleHardDrop = (player) => {
                if (!player) return;
                const clearedLines = player.hardDrop();
                if (clearedLines >= 2) {
                    gameInstances.forEach(p => {
                        if (p !== player && !p.gameOver) {
                            const attackLines = clearedLines >= 4 ? 3 : 1;
                            p.addObstacle(attackLines);
                        }
                    });
                }
            };
            
            const p1 = humanPlayers.find(g => g.playerId === 1);
            if(p1 && !p1.hasGamepadInput()) {
                if (event.code === 'ArrowLeft') p1.move(-1);
                else if (event.code === 'ArrowRight') p1.move(1);
                else if (event.code === 'ArrowDown') p1.drop();
                else if (event.code === 'KeyZ') p1.rotate();
                else if (event.code === 'ArrowUp') handleHardDrop(p1);
                else if (event.code === 'KeyX') p1.flip();
            }

            const p2 = humanPlayers.find(g => g.playerId === 2);
            if(p2 && !p2.hasGamepadInput()) {
                if (event.code === 'KeyA') p2.move(-1);
                else if (event.code === 'KeyD') p2.move(1);
                else if (event.code === 'KeyS') p2.drop();
                else if (event.code === 'KeyQ') p2.rotate();
                else if (event.code === 'KeyW') handleHardDrop(p2);
                else if (event.code === 'KeyE') p2.flip();
            }
            
            const p3 = humanPlayers.find(g => g.playerId === 3);
            if(p3 && !p3.hasGamepadInput()) {
                if (event.code === 'KeyJ') p3.move(-1);
                else if (event.code === 'KeyL') p3.move(1);
                else if (event.code === 'KeyK') p3.drop();
                else if (event.code === 'KeyP') p3.rotate();
                else if (event.code === 'KeyI') handleHardDrop(p3);
                else if (event.code === 'KeyO') p3.flip();
            }
        });
    });
  </script>
</body>
</html>