<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>三人対戦テトリス NEO</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #1a1a2e;
      --primary-color: #e94560;
      --secondary-color: #0f3460;
      --font-color: #ffffff;
      --glow-color: #fca311;
      --border-color: rgba(255, 255, 255, 0.2);
    }

    body {
      background-color: var(--bg-color);
      color: var(--font-color);
      font-family: 'Press Start 2P', cursive;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    h1 {
      font-size: 3rem;
      color: var(--primary-color);
      text-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--primary-color);
      margin-bottom: 20px;
    }

    #start-container {
      margin-bottom: 30px;
    }

    .retro-button {
      font-family: 'Press Start 2P', cursive;
      background-color: var(--primary-color);
      color: var(--font-color);
      border: none;
      padding: 15px 30px;
      font-size: 1.2rem;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.3s ease;
      box-shadow: 0 5px 0 #b32a3e, 0 8px 15px rgba(0,0,0,0.4);
      border-radius: 8px;
    }

    .retro-button:hover:not(:disabled) {
      background-color: #ff6384;
      transform: translateY(-2px);
      box-shadow: 0 7px 0 #b32a3e, 0 10px 20px rgba(0,0,0,0.5);
    }

    .retro-button:active:not(:disabled) {
      transform: translateY(5px);
      box-shadow: 0 0 0 #b32a3e, 0 3px 10px rgba(0,0,0,0.3);
    }
    
    .retro-button:disabled {
        background-color: #6c757d;
        box-shadow: 0 5px 0 #4a5157;
        cursor: not-allowed;
    }
    
    #game-container {
      display: none; /* Initially hidden */
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
      width: 100%;
      flex-wrap: wrap; /* Allow wrapping on smaller screens */
    }

    .player-container {
      background-color: var(--secondary-color);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 0 15px rgba(0,0,0,0.3);
      width: clamp(300px, 30vw, 400px); /* Responsive width */
    }

    .player-title {
        font-size: 1.5rem;
        margin-bottom: 15px;
        color: var(--primary-color);
        text-shadow: 0 0 5px var(--primary-color);
    }

    .game-area {
        display: flex;
        gap: 10px;
        width: 100%;
    }

    canvas {
      border: 1px solid var(--border-color);
      background-color: #000;
    }

    .player-container canvas {
       width: 75%;
       height: auto;
    }

    .side-panel {
        width: 25%;
        display: flex;
        flex-direction: column;
        gap: 10px;
        font-size: 0.8rem;
    }

    .info-box {
        background: #111;
        border: 1px solid var(--border-color);
        padding: 10px;
        border-radius: 5px;
        text-align: center;
    }

    .info-box h3 {
        margin: 0 0 10px 0;
        font-size: 0.9rem;
        color: var(--glow-color);
    }
    
    .info-box div {
        font-size: 1rem;
    }

    .side-panel canvas {
        width: 100%;
        height: auto;
        aspect-ratio: 1 / 1;
    }

    .controls-info {
      font-size: 0.7rem;
      margin-top: 15px;
      line-height: 1.5;
      color: #aaa;
    }
    
    #player-setup {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .player-select-card {
        background-color: var(--secondary-color);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
    }

    .player-select-card h2 {
        margin-top: 0;
        color: var(--primary-color);
    }

    .player-mode-button {
        font-family: 'Press Start 2P', cursive;
        background-color: #4CAF50;
        color: white;
        padding: 10px 15px;
        border: none;
        cursor: pointer;
        width: 150px;
        text-align: center;
        border-radius: 5px;
        transition: background-color 0.3s;
    }
    .player-mode-button[data-mode="CPU"] { background-color: #fca311; }
    .player-mode-button[data-mode="OFF"] { background-color: #6c757d; }

    .game-over-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        color: red;
        text-shadow: 2px 2px #000, 0 0 15px red;
        display: none;
        z-index: 100;
        padding: 20px;
        background: rgba(0,0,0,0.7);
        border-radius: 10px;
    }

  </style>
</head>
<body>

  <h1>三人対戦テトリス NEO</h1>

  <div id="player-setup">
    <div class="player-select-card">
      <h2>PLAYER 1</h2>
      <button class="player-mode-button" id="togglePlayer1" data-mode="ON">参加する</button>
    </div>
    <div class="player-select-card">
      <h2>PLAYER 2</h2>
      <button class="player-mode-button" id="togglePlayer2" data-mode="CPU">CPU</button>
    </div>
    <div class="player-select-card">
      <h2>PLAYER 3</h2>
      <button class="player-mode-button" id="togglePlayer3" data-mode="OFF">参加しない</button>
    </div>
  </div>

  <div id="start-container">
    <button id="startButton" class="retro-button">ゲームスタート</button>
  </div>

  <div id="game-container">
    <!-- Player 1 Container -->
    <div class="player-container" id="p1-container" style="display: none;">
      <div class="player-title">PLAYER 1</div>
      <div class="game-area">
          <canvas id="player1Canvas"></canvas>
          <div class="side-panel">
              <div class="info-box">
                  <h3>SCORE</h3>
                  <div id="player1Score">0</div>
              </div>
              <div class="info-box">
                  <h3>NEXT</h3>
                  <canvas id="player1Next"></canvas>
              </div>
          </div>
      </div>
      <small class="controls-info">矢印:移動 / ↑:ハードドロップ / Z:回転</small>
    </div>

    <!-- Player 2 Container -->
    <div class="player-container" id="p2-container" style="display: none;">
      <div class="player-title">PLAYER 2</div>
      <div class="game-area">
          <canvas id="player2Canvas"></canvas>
          <div class="side-panel">
              <div class="info-box">
                  <h3>SCORE</h3>
                  <div id="player2Score">0</div>
              </div>
               <div class="info-box">
                  <h3>NEXT</h3>
                  <canvas id="player2Next"></canvas>
              </div>
          </div>
      </div>
      <small class="controls-info">A,D,S:移動 / W:ハードドロップ / E:回転</small>
    </div>

    <!-- Player 3 Container -->
    <div class="player-container" id="p3-container" style="display: none;">
      <div class="player-title">PLAYER 3</div>
       <div class="game-area">
          <canvas id="player3Canvas"></canvas>
          <div class="side-panel">
              <div class="info-box">
                  <h3>SCORE</h3>
                  <div id="player3Score">0</div>
              </div>
               <div class="info-box">
                  <h3>NEXT</h3>
                  <canvas id="player3Next"></canvas>
              </div>
          </div>
      </div>
      <small class="controls-info">J,L,K:移動 / I:ハードドロップ / O:回転</small>
    </div>
  </div>
  
  <div id="gameOverMessage" class="game-over-message">GAME OVER</div>

  <script src="tetris.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const startButton = document.getElementById('startButton');
        
        // Gamepad detection
        let gamepadDetectionInterval;
        
        function detectGamepads() {
            const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
            const connectedGamepads = Array.from(gamepads).filter(gp => gp !== null);
            
            if (connectedGamepads.length > 0) {
                console.log('Connected gamepads:', connectedGamepads.map(gp => gp.id));
                console.log('Gamepad buttons available:', connectedGamepads[0].buttons.length);
                console.log('Gamepad axes available:', connectedGamepads[0].axes.length);
            } else {
                console.log('No gamepads detected');
            }
        }
        
        // Gamepad connection events
        window.addEventListener('gamepadconnected', (e) => {
            console.log('Gamepad connected:', e.gamepad.id, 'at index', e.gamepad.index);
            detectGamepads();
        });
        
        window.addEventListener('gamepaddisconnected', (e) => {
            console.log('Gamepad disconnected:', e.gamepad.id, 'at index', e.gamepad.index);
        });
        
        // Start gamepad detection
        gamepadDetectionInterval = setInterval(detectGamepads, 3000);
        detectGamepads(); // Initial detection
        
        if (typeof Tetris === 'undefined') {
            console.error("エラー: 'Tetris' クラスが見つかりません。tetris.jsを確認してください。");
            startButton.textContent = "読み込みエラー";
            startButton.disabled = true;
            return;
        }

        const playerModes = ['ON', 'CPU', 'OFF'];
        const playerButtons = [
            document.getElementById('togglePlayer1'),
            document.getElementById('togglePlayer2'),
            document.getElementById('togglePlayer3')
        ];
        
        playerButtons.forEach(button => {
            button.addEventListener('click', () => {
                let currentModeIndex = playerModes.indexOf(button.dataset.mode);
                let nextModeIndex = (currentModeIndex + 1) % playerModes.length;
                let nextMode = playerModes[nextModeIndex];
                button.dataset.mode = nextMode;
                const modeText = {'ON': '参加する', 'CPU': 'CPU', 'OFF': '参加しない'};
                button.textContent = modeText[nextMode];
            });
        });

        const setupDiv = document.getElementById('player-setup');
        const gameContainer = document.getElementById('game-container');
        let gameInstances = [];
        let animationFrameId;

        function requestFullScreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        startButton.addEventListener('click', () => {
            setupDiv.style.display = 'none';
            startButton.parentElement.style.display = 'none';
            document.getElementById('gameOverMessage').style.display = 'none';
            gameContainer.style.display = 'flex';
            
            // Request fullscreen
            requestFullScreen();

            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            gameInstances = []; 
            
            playerButtons.forEach((button, index) => {
                const playerId = index + 1;
                const mode = button.dataset.mode;
                const playerContainer = document.getElementById(`p${playerId}-container`);
                if (mode !== 'OFF') {
                    playerContainer.style.display = 'flex';
                    const game = new Tetris(playerId, mode);
                    game.start();
                    gameInstances.push(game);
                } else {
                    playerContainer.style.display = 'none';
                }
            });

            if(gameInstances.length > 0) {
              // Stop gamepad detection during game
              clearInterval(gamepadDetectionInterval);
              
              function gameLoop(time) {
                  const activeGames = gameInstances.filter(game => !game.gameOver);

                  if (gameInstances.length > 1 && activeGames.length <= 1) {
                      const gameOverMsg = document.getElementById('gameOverMessage');
                      gameOverMsg.textContent = activeGames.length === 1 ? `PLAYER ${activeGames[0].playerId} WINS!` : 'DRAW!';
                      gameOverMsg.style.display = 'block';
                      cancelAnimationFrame(animationFrameId);
                      // Restart gamepad detection
                      gamepadDetectionInterval = setInterval(detectGamepads, 3000);
                      return;
                  }
                  
                  gameInstances.forEach(currentGame => {
                      if (currentGame.gameOver) return;
                      const clearedLines = currentGame.update(time);
                      if (clearedLines > 0) {
                          gameInstances.forEach(otherPlayer => {
                              if (otherPlayer !== currentGame && !otherPlayer.gameOver) {
                                  otherPlayer.addObstacle(clearedLines);
                              }
                          });
                      }
                  });
                  animationFrameId = requestAnimationFrame(gameLoop);
              }
              animationFrameId = requestAnimationFrame(gameLoop);
            }
        });
        
        document.addEventListener('keydown', event => {
            const humanPlayers = gameInstances.filter(g => g.mode === 'ON' && !g.gameOver);
            if (humanPlayers.length === 0) return;

            const handleHardDrop = (player) => {
                if (!player) return;
                const clearedLines = player.hardDrop();
                if (clearedLines > 0) {
                    gameInstances.forEach(p => {
                        if (p !== player && !p.gameOver) p.addObstacle(clearedLines);
                    });
                }
            };
            
            const p1 = humanPlayers.find(g => g.playerId === 1);
            if(p1 && !p1.hasGamepadInput()) {
                if (event.code === 'ArrowLeft') p1.move(-1);
                else if (event.code === 'ArrowRight') p1.move(1);
                else if (event.code === 'ArrowDown') p1.drop();
                else if (event.code === 'KeyZ' || event.code === 'KeyX') p1.rotate();
                else if (event.code === 'ArrowUp') handleHardDrop(p1);
            }

            const p2 = humanPlayers.find(g => g.playerId === 2);
            if(p2 && !p2.hasGamepadInput()) {
                if (event.code === 'KeyA') p2.move(-1);
                else if (event.code === 'KeyD') p2.move(1);
                else if (event.code === 'KeyS') p2.drop();
                else if (event.code === 'KeyE') p2.rotate();
                else if (event.code === 'KeyW') handleHardDrop(p2);
            }
            
            const p3 = humanPlayers.find(g => g.playerId === 3);
            if(p3 && !p3.hasGamepadInput()) {
                if (event.code === 'KeyJ') p3.move(-1);
                else if (event.code === 'KeyL') p3.move(1);
                else if (event.code === 'KeyK') p3.drop();
                else if (event.code === 'KeyO') p3.rotate();
                else if (event.code === 'KeyI') handleHardDrop(p3);
            }
        });
    });
  </script>
</body>
</html>